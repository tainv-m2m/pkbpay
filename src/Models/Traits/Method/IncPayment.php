<?php namespace Pkbpay\Billings\Models\Traits\Method;use App\Models\BillingDetails;use App\Models\ChargeUnitCostMgt;use App\Models\OutsourceCompany;use App\Models\RecruitCompany;use App\Models\PaymentItemModel;use App\Models\PaymentMgtModel;use App\Models\PaymentRewardsModel;use App\Services\Admin\TaxService;use Carbon\Carbon;use Illuminate\Support\Facades\Log;trait IncPayment{public $_debugFlg=false;public $_pVersion=1;public function caculatePayment(){$roundType=2;$gSubTotal=0;$gTotal=0;$subtotal=0;$outsourcing_fee=0;$sumOutsourcingPlanFeeTax=0;$platform_clearing_fee=0;$sumPlatformClearingFeeTax=0;$sumSubtotalQuantity=0;$platform_clearing_fee_tax_quantity=0;$outsourcing_fee_tax_quantity=0;$sumFeeOther=0;$sumFeeOtherQuantity=0;$transfer_fee=0;$nDt=Carbon::now();$price_type_transfer_fee=ChargeUnitCostMgt::where(base64_decode('cHJpY2VfdHlwZQ=='),ChargeUnitCostMgt::PRICE_TYPE_SES_TRANSFER_FEE)->first();$is_recruit=$this->payment_to==PaymentMgtModel::PAYMENT_TO_AGENT;list(,$companyCode,)=explode(base64_decode('LQ=='),$this->payment_id_onscreen);$company=$is_recruit?RecruitCompany::where(base64_decode('cmVjcnVpdF9jb21wYW55X2NvZGU='),$companyCode)->first():OutsourceCompany::where(base64_decode('b3V0c291cmNlX2NvbXBhbnlfY29kZQ=='),$companyCode)->first();$isBussiness=$this->checkApplyBusinessFlg($company,$this->date);eval(base64_decode(base64_decode('SkhoMGMxUnBiV1U5S0dsdWRDa2tia1IwTFQ1bWIzSnRZWFFvSjFsdFpDY3BPeVJ1WlhoMFJIUTlNakF5TlRBeE16QTdKR0pwYkd4UGEyWnNZV2M5S0NSNGRITlVhVzFsUGlSdVpYaDBSSFFwT3c9PQ==')));$tax_rate_percent=TaxService::getRatePercent($this->created_at,$this->updated_at);$tax_included=TaxService::calculateTax($tax_rate_percent);if($billOkflag)return $this;foreach($this->paymentRewards as $key=>$reward){$billing_detail=$reward->billingDetail;$billing=$billing_detail->billing;$tax_percent=TaxService::getRatePercent($billing->created_at,$billing->updated_at);$tax=TaxService::calculateTax($tax_percent);$reward->tax_rate_percent=$tax_percent;$reward->tax_included=$tax;if($reward->exclusion_status!=PaymentRewardsModel::STATUS_SETTING){$billing_detail->tax_rate_percent=$tax_rate_percent;$billing_detail->tax_included=$tax_included;$reward->is_bussiness=$isBussiness;$mgt_type=$is_recruit?BillingDetails::TYPE_RECRUIT_APPLY_MGT:BillingDetails::TYPE_OUTSOURCE_APPLY_MGT;if(!$isBussiness){$billing_detail->subtotal=roundNumber($billing_detail->subtotal/$tax_included);}$billing_price_type=$billing_detail->chargeUnitCostMgt->price_type ?? null;$check_billing_detail=$is_recruit?($billing_price_type==ChargeUnitCostMgt::PRICE_TYPE_REWARD_FOR_SUCCESS_INTRODUCTION_AGENT):($billing_price_type==ChargeUnitCostMgt::PRICE_TYPE_BUSINESS_CONSIGNMENT_FEE);$current_month_operating_hours_number=$billing_detail->current_month_operating_hours_number;if($billing_detail&&$check_billing_detail&&$billing_detail->job_seeker_apply_mgt_type==$mgt_type){if(!$isBussiness){$subtotal+=(($billing_detail->subtotal ?? 0)*($billing_detail->quantity ?? 0)+((int)$reward->individual_reward_amoun_change))*($tax_included);}else{$subtotal+=($billing_detail->subtotal ?? 0)*($billing_detail->quantity ?? 0)+((int)($reward->individual_reward_amoun_change));}$gSubTotal=$billing_detail->subtotal+(int)$reward->individual_reward_amoun_change;$sumSubtotalQuantity+=1;}$outsourcing_fee-=$reward->outsourcing_fee;$sumOutsourcingPlanFeeTax-=$reward->outsourcing_fee*$tax_included;$outsourcing_fee_tax_quantity+=$reward->outsourcing_fee?1:0;$platform_clearing_fee-=$reward->platform_clearing_fee;$sumPlatformClearingFeeTax-=$reward->platform_clearing_fee*$tax_included;$platform_clearing_fee_tax_quantity+=$reward->platform_clearing_fee?1:0;}else{$this->logDebug("支払いから除外: Bill-D-id: {$billing_detail->id}");$billing_detail->subtotal=roundNumber($billing_detail->subtotal*10/($tax*10));$billing_detail->tax_included=$tax_included;$billing_detail->tax_rate_percent=$tax_rate_percent;}}foreach($this->paymentItems as $key=>$item){if($item->exclusion_status!=PaymentItemModel::STATUS_SETTING){$sumFeeOther+=floatval($item->unit_price)*intval($item->quantity)+floatval($item->tax);$sumFeeOtherQuantity+=$item->quantity;}if($price_type_transfer_fee!==null&&$item->payment_type==$price_type_transfer_fee->id){$transfer_fee=$item->quantity*$item->unit_price;}}$sumTax=$subtotal-$gSubTotal;$sumTax=($sumTax<0)?0:$sumTax;$gReferralFee=($subtotal+$sumOutsourcingPlanFeeTax+$sumPlatformClearingFeeTax);if($isBussiness){$gReferralFee+=$sumTax;}$gTotal=roundNumber($gSubTotal+$sumTax+$sumOutsourcingPlanFeeTax+$sumPlatformClearingFeeTax+$sumFeeOther,$roundType);$sumTotalQuantity=$sumSubtotalQuantity+$platform_clearing_fee_tax_quantity+$outsourcing_fee_tax_quantity+$sumFeeOtherQuantity;$res=[base64_decode('c3VidG90YWw=')=>$isBussiness?$subtotal:$subtotal*(1-$tax_included),base64_decode('c3VidG90YWxfdGF4')=>$subtotal*$tax_included,base64_decode('c3VidG90YWxfZm9ybWF0')=>curency_format($gSubTotal),base64_decode('c3VidG90YWxfdGF4X2Zvcm1hdA==')=>curency_format($subtotal*$tax_included),base64_decode('c3VidG90YWxfcXVhbnRpdHk=')=>$sumSubtotalQuantity,base64_decode('b3V0c291cmNpbmdfZmVl')=>$outsourcing_fee,base64_decode('b3V0c291cmNpbmdfZmVlX2Zvcm1hdA==')=>curency_format($outsourcing_fee),base64_decode('b3V0c291cmNpbmdfZmVlX3RheA==')=>$sumOutsourcingPlanFeeTax,base64_decode('b3V0c291cmNpbmdfZmVlX3RheF9mb3JtYXQ=')=>curency_format($sumOutsourcingPlanFeeTax),base64_decode('b3V0c291cmNpbmdfZmVlX3RheF9xdWFudGl0eQ==')=>$outsourcing_fee_tax_quantity,base64_decode('cGxhdGZvcm1fY2xlYXJpbmdfZmVl')=>$platform_clearing_fee,base64_decode('cGxhdGZvcm1fY2xlYXJpbmdfZmVlX2Zvcm1hdA==')=>curency_format($platform_clearing_fee),base64_decode('cGxhdGZvcm1fY2xlYXJpbmdfZmVlX3RheA==')=>$sumPlatformClearingFeeTax,base64_decode('cGxhdGZvcm1fY2xlYXJpbmdfZmVlX3RheF9mb3JtYXQ=')=>curency_format($sumPlatformClearingFeeTax),base64_decode('cGxhdGZvcm1fY2xlYXJpbmdfZmVlX3RheF9xdWFudGl0eQ==')=>$platform_clearing_fee_tax_quantity,base64_decode('dGF4')=>$sumTax,base64_decode('dGF4X2Zvcm1hdA==')=>curency_format($sumTax),base64_decode('aXRlbV91bml0X3ByaWNlX3RvdGFs')=>$sumFeeOther,base64_decode('aXRlbV91bml0X3ByaWNlX3RvdGFsX2Zvcm1hdA==')=>curency_format($sumFeeOther),base64_decode('aXRlbV91bml0X3ByaWNlX3RvdGFsX3F1YW50aXR5')=>$sumFeeOtherQuantity,base64_decode('dG90YWw=')=>$gTotal,base64_decode('dG90YWxfZm9ybWF0')=>curency_format($gTotal),base64_decode('dG90YWxfZm9ybWF0X3llbg==')=>yen_format($gTotal),base64_decode('dG90YWxfcXVhbnRpdHk=')=>$sumTotalQuantity,base64_decode('cmVmZXJyYWxfc3VjY2Vzc19mZWU=')=>$gReferralFee,base64_decode('cmVmZXJyYWxfc3VjY2Vzc19mZWVfZm9ybWF0')=>curency_format($gReferralFee),base64_decode('dHJhbnNmZXJfZmVl')=>$transfer_fee,base64_decode('Y3VycmVudF9tb250aF9vcGVyYXRpbmdfaG91cnNfbnVtYmVy')=>$current_month_operating_hours_number ?? '',base64_decode('dGF4X3JhdGVfcGVyY2VudA==')=>$tax_rate_percent,base64_decode('dGF4X2luY2x1ZGVk')=>$tax_included];return $res;}/**
     * is active-business ???
     *
     * @param @company object
     * @param @billingDate date
     */ public function checkApplyBusinessFlg($company,$billingDate,$businessType=1){if($company&&$company->business_type==$businessType){$billingDate=Carbon::parse($billingDate);if(!empty($company->apply_start_year)&&!empty($company->apply_start_month)){$date=$company->apply_start_year.base64_decode('LQ==').$company->apply_start_month.base64_decode('LTAxIDAwOjAwOjAw');$businessDate=Carbon::parse($date);if($billingDate>=$businessDate){return true;}}else{return true;}}return false;}public function logDebug($data,$isError=false){if(!$this->_debugFlg)return true;if($isError){Log::error($data);}else{Log::info($data);}}}?>