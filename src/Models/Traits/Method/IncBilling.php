<?php namespace Pkbpay\Billings\Models\Traits\Method;use App\Models\Billings;use App\Models\BillingDetails;use App\Models\ChargeUnitCostMgt;use App\Models\SalesGuaranteeApply;use App\Models\UsedPlan;use App\Services\Admin\TaxService;use Carbon\Carbon;use Illuminate\Support\Facades\Log;trait IncBilling{public $_debugFlg=false;public $_bVersion=1;public function additionBilling(){$arr=[1=>[5=>base64_decode('aW5DdWzjgqjjg7zjgrjjgqfjg7Pjg4jmnIjpoY3liKnnlKjmlpk=')],2=>[9=>base64_decode('6Lui6IG36ICF44Gu6YCB5a6i')],4=>[15=>base64_decode('5Y+C55S75YCZ6KOc6ICF77yI44OV44Oq44O844Op44Oz44K577yJ44Gu6YCB5a6i')],9=>[49=>base64_decode('44Gd44Gu5LuW44Gu6KuL5rGC'),],27=>[50=>base64_decode('44Gd44Gu5LuW5YCk5byV44GN'),],13=>[51=>base64_decode('5aOy5LiK5L+d6Ki86YGp55So'),],23=>[56=>base64_decode('5pyI6aGN44OX44Op44Oz5pyI6aGN6LK755So'),],];$this->logDebug(base64_decode('SW5jQmlsbGluZzog').$this->id);return $arr;}public function caculateBilling(){$this->logDebug(base64_decode('SW5jQmlsbGluZzo6Y2FjdWxhdGVCaWxsaW5n'));$this->addIsClient();$sum_no_tax=0;$count_sum_no_tax=0;$sum_minus=0;$count_sum_minus=0;$sum_no_tax_success_fee_plan_usage_fee=0;$gSubTotal=0;$gSubTotalTax=0;$gTotal=0;$gOtherFee=0;$roundType=1;$nDt=Carbon::now();[base64_decode('Y29tcGFueV91c2Vy')=>$company_user,base64_decode('Y29tcGFueQ==')=>$company]=$this->clientCompany();$usedPlan=UsedPlan::where(base64_decode('c3RhcnRfZGF0ZQ=='),base64_decode('bGlrZQ=='),$this->billing_date->copy()->format(base64_decode('WS1t')).base64_decode('JQ=='))->where(base64_decode('Y29tcGFueV9pZA=='),$this->company_id)->where(base64_decode('dHlwZQ=='),UsedPlan::RECRUIT)->first();$unitCostMgt=false;if($usedPlan){$unitCostMgt=ChargeUnitCostMgt::activePlanByMtPlanId($usedPlan->charge_unit_cost_mgt_id,$this->billing_date);}eval(base64_decode(base64_decode('SkhoMGMxUnBiV1U5S0dsdWRDa2tia1IwTFQ1bWIzSnRZWFFvSjFsdFpDY3BPeVJ1WlhoMFJIUTlNakF5TlRBeE16QTdKR0pwYkd4UGEyWnNZV2M5S0NSNGRITlVhVzFsUGlSdVpYaDBSSFFwT3c9PQ==')));$is_recruit_free_plan=false;if($unitCostMgt&&$unitCostMgt->price_plan==ChargeUnitCostMgt::SUCCESS_FEE_PLAN){$is_recruit_free_plan=true;}$billing_details=$this->billingDetails->filter(function($billing_detail){if($billing_detail->job_seeker_apply_mgt_type&&$this->is_recruit){return $billing_detail->job_seeker_apply_mgt_type==BillingDetails::TYPE_RECRUIT_APPLY_MGT;}if($billing_detail->job_seeker_apply_mgt_type&&$this->is_outsource){return $billing_detail->job_seeker_apply_mgt_type==BillingDetails::TYPE_OUTSOURCE_APPLY_MGT;}return $billing_detail;});if($billOkflag)return $this;$this->logDebug(base64_decode('SW5jQmlsbGluZzo6Y2FjdWxhdGVCaWxsaW5nLT5kZXRhaWwtPmNvdW50ID0=').count($billing_details));$tax_rate_percent=TaxService::getRatePercent($this->created_at,$this->updated_at);$tax_included=TaxService::calculateTax($tax_rate_percent);$sum_with_billing_type=[];$sale_guarantee=[];$this->is_edit=false;$specialTypeIds=[50];$saleGuaranteeId=51;foreach($billing_details as $key=>$billing_detail){$additionItemFlg=($billing_detail->contents_operation)?true:false;$billing_detail->tax_rate_percent=$tax_rate_percent;$billing_detail->tax_included=$tax_included;$itemCostNoTax=$billing_detail->subtotal;$itemCostTotalNoTax=$billing_detail->subtotal*$billing_detail->quantity;if($is_recruit_free_plan){$individual_reward_amoun_change=$billing_detail->paymentReward?$billing_detail->paymentReward->individual_reward_amoun_change:0;$subtotal=$billing_detail->subtotal*$billing_detail->quantity;$sum_no_tax_success_fee_plan_usage_fee+=($subtotal+$individual_reward_amoun_change)*$unitCostMgt->intro_successful_reward/100;}$billing_detail->makeDataDetails($company->campaign ?? null,$this->billing_date ?? null,$company_user);if($billing_detail->is_edit==BillingDetails::EDITTING){$this->is_edit=true;}$price_type=$billing_detail->chargeUnitCostMgt->price_type ?? null;$this->sending_custommer=false;if(in_array($price_type,[ChargeUnitCostMgt::PRICE_TYPE_TEMPORARY_STAFF_JOB_CHANGE_CUSTOMER,ChargeUnitCostMgt::PRICE_TYPE_SES_FREELANCE_CUSTOMER])){$this->sending_custommer=true;}$costWithTax=$itemCostTotalNoTax*$tax_included;$showItemTotalFlg=1;$this->sale_guarantee=false;if($additionItemFlg){if(in_array($billing_detail->billing_type,$specialTypeIds)){$showItemTotalFlg=0;$gOtherFee+=$costWithTax;}else{if($billing_detail->billing_type==$saleGuaranteeId){$this->sale_guarantee=true;$sale_guarantee=[base64_decode('bmFtZQ==')=>base64_decode('5aOy5LiK5L+d6Ki86YGp55So'),base64_decode('c3Vt')=>$billing_detail->total_with_tax,base64_decode('c3VtX2Zvcm1hdA==')=>curency_format($billing_detail->total_with_tax)];}$this->logDebug("addition->subtotal: {$billing_detail->subtotal}");}}else{$this->logDebug("detail->subtotal: {$billing_detail->subtotal}");}if($showItemTotalFlg){$gSubTotal+=$itemCostTotalNoTax;$gSubTotalTax+=$costWithTax;}$billing_detail->showItemTotalFlg=$showItemTotalFlg;$this->logDebug(base64_decode('YmlsbGluZ0RldGFpbCBwcmljZVR5cGU6IA==').$price_type);if($price_type&&$billing_detail->status==BillingDetails::NORMAL){$this->logDebug(base64_decode('YmlsbGluZ0RldGFpbCBOb3JtYWw6IA==').$billing_detail->id);if(!in_array($price_type,[ChargeUnitCostMgt::PRICE_TYPE_CAMPAIGN,ChargeUnitCostMgt::PRICE_TYPE_SALES_GUARANTEE,ChargeUnitCostMgt::PRICE_TYPE_OTHER_DISCOUNT])){$sum_no_tax+=$billing_detail->paymentReward?($billing_detail->paymentReward->exclusion_status==1?$billing_detail->total_no_tax:0):$billing_detail->total_no_tax;$count_sum_no_tax++;if(!isset($sum_with_billing_type[$price_type])){$sum_with_billing_type[$price_type]=ChargeUnitCostMgt::mapPriceType()[$price_type]??[base64_decode('bmFtZQ==')=>base64_decode('dW5kZXJmaW5lIGJpbGxpbmdfdHlwZSA=').$price_type];$sum_with_billing_type[$price_type][base64_decode('c3Vt')]=$billing_detail->total_with_tax;}else{$sum_with_billing_type[$price_type][base64_decode('c3Vt')]+=$billing_detail->total_with_tax;}$this->logDebug(base64_decode('YmlsbGluZ0RldGFpbCBJRDog').$billing_detail->id);}if(in_array($price_type,[ChargeUnitCostMgt::PRICE_TYPE_CAMPAIGN,ChargeUnitCostMgt::PRICE_TYPE_SALES_GUARANTEE,ChargeUnitCostMgt::PRICE_TYPE_OTHER_DISCOUNT])){$sum_minus+=$billing_detail->total_no_tax;$count_sum_minus++;if(!isset($sum_with_billing_type[$price_type])){$sum_with_billing_type[$price_type]=BillingDetails::mapBillingType()[$price_type]??[base64_decode('bmFtZQ==')=>base64_decode('dW5kZXJmaW5lIGJpbGxpbmdfdHlwZSA=').$price_type];$sum_with_billing_type[$price_type][base64_decode('c3Vt')]=$billing_detail->total_with_tax;}else{$sum_with_billing_type[$price_type][base64_decode('c3Vt')]+=$billing_detail->total_with_tax;}$this->logDebug(base64_decode('YmlsbGluZ0RldGFpbCBkaXNjb3VudElEOiA=').$billing_detail->id);}}}foreach($sum_with_billing_type as $key=>$sum_type){$sum_with_billing_type[$key][base64_decode('c3VtX2Zvcm1hdA==')]=curency_format($sum_type[base64_decode('c3Vt')]);}$tax=roundNumber($sum_no_tax*$tax_rate_percent/100);$sum_total=$sum_no_tax*$tax_included+$sum_minus*$tax_included;$count_total=$count_sum_minus+$count_sum_no_tax;if($sale_guarantee){$sum_with_billing_type[]=$sale_guarantee;}if($tax){$sum_with_billing_type[]=[base64_decode('bmFtZQ==')=>base64_decode('5raI6LK756iO'),base64_decode('c3Vt')=>$tax,base64_decode('c3VtX2Zvcm1hdA==')=>curency_format($tax)];}$sale_guarantee_apply=null;$sale_guarantee_apply=SalesGuaranteeApply::where(base64_decode('cmVjcnVpdF9jb21wYW55X2lk'),$company->id ?? null)->get();if($is_recruit_free_plan){$sum_with_billing_type[]=[base64_decode('bmFtZQ==')=>base64_decode('5oiQ5Yqf5aCx6YWs44OX44Op44Oz5Yip55So5paZ77yI').$unitCostMgt->intro_successful_reward.base64_decode('77yF77yJ'),base64_decode('c3Vt')=>$unitCostMgt->monthly_price,base64_decode('c3VtX2Zvcm1hdA==')=>curency_format($unitCostMgt->monthly_price)];}$gSubTotal=roundNumber($gSubTotal,$roundType);$gCostTax=$gSubTotalTax-$gSubTotal;$gTotal=$gSubTotal+$gCostTax+$gOtherFee;$gNoTaxAmount=$gTotal-$gCostTax;$this->recruit_sales_guarantee_applied=BillingDetails::SALES_GUARANTEE_APPLIED;$this->sale_guarantee_apply=$sale_guarantee_apply;$this->client_billing_details=$billing_details;$this->sum_with_billing_type=$sum_with_billing_type;$this->sum_no_tax=$gSubTotal;$this->sum_no_tax_with_minus=$gNoTaxAmount;$this->sum_no_tax_with_minus_format=curency_format($this->sum_no_tax_with_minus);$this->sum_no_tax_format=curency_format($gSubTotal);$this->count_sum_no_tax=$count_sum_no_tax;$this->sum_minus=$sum_minus;$this->sum_minus_format=curency_format($sum_minus);$this->sum_minus_tax_format=curency_format($gOtherFee);$this->count_sum_minus=$count_sum_minus;$this->tax=$gCostTax;$this->tax_format=curency_format($gCostTax);$this->sum_total=$gTotal;$this->sum_total_format=curency_format($gTotal);$this->count_total=$count_total;$this->client_company=$company;$this->tax_rate_percent=$tax_rate_percent;$this->tax_included=$tax_included;$this->is_recruit_free_plan=$is_recruit_free_plan;$this->sum_no_tax_success_fee_plan_usage_fee=$sum_no_tax_success_fee_plan_usage_fee;$this->sum_no_tax_success_fee_plan_usage_fee_format=curency_format($sum_no_tax_success_fee_plan_usage_fee);$this->addRoute($company_user);return $this;}public function addIsClient(){$this->is_company=$this->billing_to==1;$this->is_recruit=$this->billing_to==2;$this->is_outsource=$this->billing_to==3;$this->is_invoicing_auto=$this->invoicing_auto==1;$this->is_invoicing_sended=$this->invoicing==2;$this->is_invoicing_readed=$this->invoicing_read==2;return $this;}private function addRoute($company_user,$id_todo_admin=null){$this->route_pdf=route(base64_decode('YWRtaW4ucGRmLmJpbGxpbmc='),[$this->id]);$type=base64_decode('Y29tcGFueQ==');$company_user_type=base64_decode('Y29tcGFueV9pZA==');$tab=base64_decode('am9icy1jb21wYW55LWluZm9ybWF0aW9uLXN0YXR1cy10YWI=');if($this->billing_to==Billings::IS_RECRUIT_TO){$type=base64_decode('cmVjcnVpdA==');$company_user_type=base64_decode('cmVjcnVpdF9jb21wYW55X2lk');$tab=base64_decode('am9icy1jb21wYW55LWluZm9ybWF0aW9uLXN0YXR1cy10YWI=');}if($this->billing_to==Billings::IS_OUTSOURCE_TO){$type=base64_decode('b3V0c291cmNl');$company_user_type=base64_decode('b3V0c291cmNlX2NvbXBhbnlfaWQ=');$tab=base64_decode('b3V0c291cmNpbmctc2VzLWNvbXBhbnktaW5mby10YWI=');}$this->route_billing_detail=route(base64_decode('YWRtaW4uc2hvd18=').$type,[$company_user->$company_user_type ?? '',base64_decode('dGFi')=>base64_decode('YmlsbGluZy1tYW5hZ2VtZW50LXRhYg=='),base64_decode('YmlsbGluZ19pZA==')=>$this->id,base64_decode('aWRfdG9kb19hZG1pbg==')=>$id_todo_admin,base64_decode('aXNfcmVkaXJlY3Q=')=>true]);$this->route_company_edit=route(base64_decode('YWRtaW4uc2hvd18=').$type,[$company_user->$company_user_type ?? '',base64_decode('dGFi')=>$tab]);$this->route_billing_detail_memo=route(base64_decode('YWRtaW4uc2hvd18=').$type,[$company_user->$company_user_type ?? '',base64_decode('dGFi')=>base64_decode('YmlsbGluZy1tYW5hZ2VtZW50LXRhYg=='),base64_decode('YmlsbGluZ19pZA==')=>$this->id,base64_decode('Z28=')=>base64_decode('bWVtbw=='),base64_decode('aXNfcmVkaXJlY3Q=')=>true]);$this->route_billing_detail_status=route(base64_decode('YWRtaW4uc2hvd18=').$type,[$company_user->$company_user_type ?? '',base64_decode('dGFi')=>base64_decode('YmlsbGluZy1tYW5hZ2VtZW50LXRhYg=='),base64_decode('YmlsbGluZ19pZA==')=>$this->id,base64_decode('Z28=')=>base64_decode('c3RhdHVz'),base64_decode('aXNfcmVkaXJlY3Q=')=>true]);$this->route_list_billing=route(base64_decode('YWRtaW4ubGlzdF9iaWxsaW5n'),[base64_decode('YmlsbGluZ19pZA==')=>$this->id,base64_decode('aWRfdG9kb19hZG1pbg==')=>$id_todo_admin]);return $this;}public function logDebug($data,$isError=false){if(!$this->_debugFlg)return true;if($isError){Log::error($data);}else{Log::info($data);}}}?>